<?php
// Iniciar sessão
session_start();

// Verificar se o usuário está logado, senão redireci        <form action="../backend/processar_artigo.php" method="post" enctype="multipart/form-data">
            <!-- Campo oculto para definir a ação -->
            <input type="hidden" name="acao" value="enviar">
            
            <div class="form-group mb-3">
                <label for="titulo">Título</label>
                <input type="text" id="titulo" name="titulo" class="form-control <?php echo (!empty($titulo_err)) ? 'is-invalid' : ''; ?>" value="<?php echo $titulo; ?>">
                <span class="invalid-feedback"><?php echo $titulo_err; ?></span>
            </div>ara a página de login
if (!isset($_SESSION["loggedin"]) || $_SESSION["loggedin"] !== true) {
    header("location: login.php");
    exit;
}

// Incluir arquivo de configuração e helper de usuário
require_once "../backend/config.php";
require_once "../backend/usuario_helper.php";

// Obter a foto de perfil do usuário
$foto_perfil = obter_foto_perfil($conn, $_SESSION["id"]);

// Definir variáveis e inicializar com valores vazios
$titulo = $conteudo = $categoria = "";
$titulo_err = $conteudo_err = $categoria_err = $imagem_err = "";
$upload_status = "";

// Verificar se há mensagens na sessão
if (isset($_SESSION['mensagem']) && isset($_SESSION['tipo_mensagem'])) {
    if ($_SESSION['tipo_mensagem'] == 'danger') {
        if ($_SESSION['tipo_mensagem'] == 'danger' && isset($_SESSION['titulo'])) {
            $titulo = $_SESSION['titulo'];
        }
        if ($_SESSION['tipo_mensagem'] == 'danger' && isset($_SESSION['conteudo'])) {
            $conteudo = $_SESSION['conteudo'];
        }
        if ($_SESSION['tipo_mensagem'] == 'danger' && isset($_SESSION['categoria'])) {
            $categoria = $_SESSION['categoria'];
        }
        
        // Definir mensagens de erro
        if (strpos($_SESSION['mensagem'], 'título') !== false) {
            $titulo_err = $_SESSION['mensagem'];
        } else if (strpos($_SESSION['mensagem'], 'conteúdo') !== false) {
            $conteudo_err = $_SESSION['mensagem'];
        } else if (strpos($_SESSION['mensagem'], 'categoria') !== false) {
            $categoria_err = $_SESSION['mensagem'];
        } else if (strpos($_SESSION['mensagem'], 'imagem') !== false || strpos($_SESSION['mensagem'], 'arquivo') !== false) {
            $imagem_err = $_SESSION['mensagem'];
        }
    }
    
    // Limpar mensagens da sessão
    unset($_SESSION['mensagem']);
    unset($_SESSION['tipo_mensagem']);
    if (isset($_SESSION['titulo'])) unset($_SESSION['titulo']);
    if (isset($_SESSION['conteudo'])) unset($_SESSION['conteudo']);
    if (isset($_SESSION['categoria'])) unset($_SESSION['categoria']);
}
?>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enviar Artigo - EntreLinhas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/user-menu.css">
    <link rel="stylesheet" href="../assets/css/alerts.css">
    <!-- Substituindo TinyMCE pelo CKEditor (sem necessidade de API key) -->
    <script src="https://cdn.ckeditor.com/4.16.2/standard-all/ckeditor.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            CKEDITOR.replace('editor', {
                height: 400,
                removePlugins: 'elementspath',
                resize_enabled: true,
                extraPlugins: 'colorbutton,font,justify,uploadimage',
                toolbar: [
                    { name: 'document', items: [ 'Source' ] },
                    { name: 'clipboard', items: [ 'Undo', 'Redo' ] },
                    { name: 'styles', items: [ 'Format', 'Font', 'FontSize' ] },
                    { name: 'basicstyles', items: [ 'Bold', 'Italic', 'Underline', 'Strike', 'RemoveFormat', 'TextColor', 'BGColor' ] },
                    { name: 'paragraph', items: [ 'NumberedList', 'BulletedList', 'Outdent', 'Indent', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock' ] },
                    { name: 'links', items: [ 'Link', 'Unlink' ] },
                    { name: 'insert', items: [ 'Image', 'Table', 'HorizontalRule', 'SpecialChar' ] },
                    { name: 'tools', items: [ 'Maximize' ] }
                ]
            });
        });
    </script>
</head>
<body>
    <?php include "includes/header.php"; ?>

    <main class="container my-5">
        <h1 class="mb-4">Enviar Novo Artigo</h1>
        
        <?php if (!empty($upload_status)): ?>
            <div class="alert alert-success"><?php echo $upload_status; ?></div>
        <?php endif; ?>
        
        <form action="../backend/processar_artigo.php" method="post" enctype="multipart/form-data">
            <div class="form-group mb-3">
                <label for="titulo">Título</label>
                <input type="text" id="titulo" name="titulo" class="form-control <?php echo (!empty($titulo_err)) ? 'is-invalid' : ''; ?>" value="<?php echo $titulo; ?>">
                <span class="invalid-feedback"><?php echo $titulo_err; ?></span>
            </div>
            
            <div class="form-group mb-3">
                <label for="categoria">Categoria</label>
                <select id="categoria" name="categoria" class="form-control <?php echo (!empty($categoria_err)) ? 'is-invalid' : ''; ?>">
                    <option value="">Selecione uma categoria</option>
                    <option value="Educação" <?php echo ($categoria == "Educação") ? "selected" : ""; ?>>Educação</option>
                    <option value="Cultura" <?php echo ($categoria == "Cultura") ? "selected" : ""; ?>>Cultura</option>
                    <option value="Esporte" <?php echo ($categoria == "Esporte") ? "selected" : ""; ?>>Esporte</option>
                    <option value="Tecnologia" <?php echo ($categoria == "Tecnologia") ? "selected" : ""; ?>>Tecnologia</option>
                    <option value="Comunidade" <?php echo ($categoria == "Comunidade") ? "selected" : ""; ?>>Comunidade</option>
                    <option value="Eventos" <?php echo ($categoria == "Eventos") ? "selected" : ""; ?>>Eventos</option>
                </select>
                <span class="invalid-feedback"><?php echo $categoria_err; ?></span>
            </div>
            
            <div class="form-group mb-3">
                <label for="imagem">Imagem de Capa (opcional)</label>
                <input type="file" id="imagem" name="imagem" class="form-control <?php echo (!empty($imagem_err)) ? 'is-invalid' : ''; ?>">
                <small class="form-text text-muted">Formatos aceitos: JPG, PNG, GIF</small>
                <span class="invalid-feedback"><?php echo $imagem_err; ?></span>
            </div>
            
            <div class="form-group mb-3">
                <label for="editor">Conteúdo</label>
                <textarea id="editor" name="conteudo" class="form-control <?php echo (!empty($conteudo_err)) ? 'is-invalid' : ''; ?>"><?php echo $conteudo; ?></textarea>
                <span class="invalid-feedback"><?php echo $conteudo_err; ?></span>
            </div>
            
            <div class="form-group mb-3">
                <button type="submit" class="btn btn-primary">Enviar Artigo</button>
                <a href="index.php" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </main>

    <?php include "includes/footer.php"; ?>
    
    <script src="../assets/js/main.js"></script>
    <script src="../assets/js/user-menu.js"></script>
    <script src="../assets/js/header-nav.js"></script>
</body>
</html>
<?php 
// Fechar a conexão com o banco de dados no final da página
if (isset($conn) && $conn) {
    mysqli_close($conn);
}
?>
